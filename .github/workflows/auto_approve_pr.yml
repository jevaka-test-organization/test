name: Auto Approve PR on Release
on:
  pull_request:
    branches:
      - develop

jobs:
  logLatestRelease:
    runs-on: ubuntu-latest
    steps:
      - uses: octokit/graphql-action@v2.x
        id: get_latest_release
        with:
          query: |
            query release($owner:String!,$repo:String!) {
              repository(owner:$owner,name:$repo) {
                releases(first:1) {
                  nodes {
                    name
                    createdAt
                    tagName
                    description
                  }
                }
              }
            }
          owner: ${{ github.event.repository.owner.name }}
          repo: ${{ github.event.repository.name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - run: "echo 'latest release: ${{ steps.get_latest_release.outputs.data }}'"
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: octokit/graphql-action@v2.x
        id: is_member_of_team
        with:
          query: |
            query {
              organization(login: "jevaka-test-organization") {
                teams(first: 100, userLogins: ["${{ github.actor }}"]) {
                  totalCount
                  edges {
                    node {
                      name
                    }
                  }
                }
              }
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - run: "echo 'member of teams: ${{ steps.is_member_of_team.outputs.data }}'"

      # Grr... need to run a GraphQL query to test github.actor belongs to a team...
      # if not, then stop here.

      - uses: hmarr/auto-approve-action@v2.0.0
        if: github.head_ref == 'master' || startsWith('meta/', github.head_ref)
        # if: github.actor == '@only-cklewin-and-testuser9891'
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
